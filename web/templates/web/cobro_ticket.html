{% extends "web/base.html" %}
{% block title %}Cobro Ticket{% endblock %}

{% block content %}
<h2>ðŸ§¾ Ticket #{{ ticket.Id_Ticket }}</h2>

<hr>

<h3>Medicamentos</h3>
<table border="1" cellpadding="6">
  <tr>
    <th>Medicamento</th>
    <th>Cantidad</th>
    <th>Precio</th>
    <th>Subtotal</th>
  </tr>
  {% for m in meds_ticket %}
  <tr>
    <td>{{ m.Id_Medicamento.nombre }}</td>
    <td>{{ m.cantidad }}</td>
    <td>${{ m.precio_unitario }}</td>
    <td>${{ m.subtotal }}</td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="4">No hay medicamentos agregados</td>
  </tr>
  {% endfor %}
</table>

<br>

<h3>Servicios</h3>
<table border="1" cellpadding="6">
  <tr>
    <th>Servicio</th>
    <th>Precio</th>
  </tr>
  {% for s in servs_ticket %}
  <tr>
    <td>{{ s.Id_Servicio.nombre_servicio }}</td>
    <td>${{ s.precio }}</td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="2">No hay servicios agregados</td>
  </tr>
  {% endfor %}
</table>

<hr>

<h3>Total: <strong>${{ total }}</strong></h3>

<hr>

<h3>Agregar medicamento</h3>
<form id="form-med">
  {% csrf_token %}
  <input type="hidden" name="ticket_id" value="{{ ticket.Id_Ticket }}">

  <select name="medicamento" required>
    {% for m in medicamentos %}
      <option value="{{ m.Id_medicamento }}">
        {{ m.nombre }} (Stock: {{ m.cantidad }})
      </option>
    {% endfor %}
  </select>

  <input type="number" name="cantidad" min="1" required>
  <button type="submit">Agregar</button>
</form>

<br>

<h3>Agregar servicio</h3>
<form id="form-serv">
  {% csrf_token %}
  <input type="hidden" name="ticket_id" value="{{ ticket.Id_Ticket }}">

  <select name="servicio" required>
    {% for s in servicios %}
      <option value="{{ s.Id_Servicio }}">
        {{ s.nombre_servicio }} (${{ s.costo }})
      </option>
    {% endfor %}
  </select>

  <button type="submit">Agregar</button>
</form>

<hr>

  <br>
  <a href="{% url 'resumen_ticket' ticket.Id_Ticket %}" >
    <button type="button" class="btn btn-primary">Continuar</button>
</a>

<br>
</form>

<br>
<a href="{% url 'cobro_inicio' %}">
  <button>â¬… Regresar</button>
</a>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

document.getElementById("form-med").onsubmit = e => {
  e.preventDefault();
  fetch("{% url 'agregar_medicamento_ticket' %}", {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken},
    body: new FormData(e.target)
  }).then(() => location.reload());
};

document.getElementById("form-serv").onsubmit = e => {
  e.preventDefault();
  fetch("{% url 'agregar_servicio_ticket' %}", {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken},
    body: new FormData(e.target)
  }).then(() => location.reload());
};
</script>

{% endblock %}
