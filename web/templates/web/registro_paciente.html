{% extends "web/base.html" %}
{% load static %}

{% block title %}Registro de Paciente{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/registro.css' %}">

<div class="form-container">

<h2>Registro de Paciente</h2>

<form method="POST" id="registroForm">
    {% csrf_token %}

    <label>Nombre:</label>
    <input type="text" name="nombre" required>

    <label>Apellido Paterno:</label>
    <input type="text" name="apellido_P" required>

    <label>Apellido Materno:</label>
    <input type="text" name="apellido_M">

    <label>Calle:</label>
    <input type="text" name="calle" required>

    <label>Colonia:</label>
    <input type="text" name="colonia" required>

    <label>Código Postal:</label>
    <input type="text" name="cp" maxlength="5" required>

    <label>CURP:</label>
    <input type="text" name="curp" id="curp" maxlength="18" required>
    <small id="curp-msg"></small>

    <label>Correo:</label>
    <input type="email" name="correo" id="correo" required>
    <small id="correo-msg"></small>

    <label>Teléfono:</label>
    <input type="text" name="tel" maxlength="10">

    <label>Contraseña:</label>
    <input type="password" name="contraseña" required>

    <label>Confirmar contraseña:</label>
    <input type="password" name="contraseña2" required>

    <label>Edad:</label>
        <select name="edad" required>
            <option value="">-- Selecciona --</option>
            {% for n in edades %}
            <option value="{{ n }}">{{ n }}</option>
            {% endfor %}
        </select>


    <label>Peso (opcional):</label>
    <input type="number" step="0.01" name="peso">

    <label>Estatura (opcional):</label>
    <input type="number" step="0.01" name="estatura">

    <label>Sexo:</label>
    <select name="sexo" required>
        <option value="">-- Selecciona --</option>
        <option value="F">Mujer</option>
        <option value="M">Hombre</option>
    </select>

    <label>Tipo de Sangre:</label>
    <select name="tipo_sangre">
        <option value="">-- Selecciona --</option>
        <option>O+</option>
        <option>O-</option>
        <option>A+</option>
        <option>A-</option>
        <option>B+</option>
        <option>B-</option>
        <option>AB+</option>
        <option>AB-</option>
    </select>

    <label>Contacto de emergencia:</label>
    <input type="text" name="contacto_emer">

    <button type="submit">Registrarse</button>
    <a href="{% url 'login' %}"><button type="button">Regresar</button></a>

</form>

{% for message in messages %}
    <p class="alert">{{ message }}</p>
{% endfor %}

</div>

<script>
// Validación CURP
document.getElementById("curp").addEventListener("input", function() {
    const regex = /^[A-Z]{1}[AEIOUX]{1}[A-Z]{2}\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])[HM](AS|BC|BS|CC|CL|CM|CS|CH|DF|DG|GT|GR|HG|JC|MC|MN|MS|NT|NL|OC|PL|QT|QR|SP|SL|SR|TC|TS|TL|VZ|YN|ZS|NE)[B-DF-HJ-NP-TV-Z]{3}[A-Z0-9]{1}\d{1}$/;
    const msg = document.getElementById("curp-msg");
    if (!regex.test(this.value.toUpperCase())) {
        msg.textContent = "CURP inválida";
        msg.style.color = "red";
    } else {
        msg.textContent = "CURP válida";
        msg.style.color = "green";
    }
});

// Verificar correo disponible
document.getElementById("correo").addEventListener("blur", function() {
    const correo = this.value;
    fetch(`/validar_correo/?correo=${correo}`)
    .then(r => r.json())
    .then(data => {
        const msg = document.getElementById("correo-msg");
        if (data.existe) {
            msg.textContent = "Este correo ya está registrado";
            msg.style.color = "red";
        } else {
            msg.textContent = "Correo disponible";
            msg.style.color = "green";
        }
    });
});
</script>

{% endblock %}
